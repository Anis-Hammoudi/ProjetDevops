---
# Initialize Docker Swarm on the manager node

- name: Check if Swarm is already initialized
  command: docker info --format '{{ "{{" }}.Swarm.LocalNodeState{{ "}}" }}'
  register: swarm_status
  changed_when: false

- name: Initialize Docker Swarm
  command: docker swarm init --advertise-addr {{ swarm_manager_ip }}
  when: swarm_status.stdout != "active"
  register: swarm_init

- name: Get Swarm worker join token
  command: docker swarm join-token worker -q
  register: worker_token
  changed_when: false

- name: Get Swarm manager join token
  command: docker swarm join-token manager -q
  register: manager_token
  changed_when: false

- name: Store worker token for other nodes
  set_fact:
    swarm_worker_token: "{{ worker_token.stdout }}"
    swarm_manager_token: "{{ manager_token.stdout }}"

- name: Create overlay network for services
  command: docker network create --driver overlay --attachable {{ swarm_network_name }}
  ignore_errors: yes
  changed_when: false

- name: Label manager node
  command: docker node update --label-add node.role=manager {{ inventory_hostname }}
  ignore_errors: yes
  changed_when: false
