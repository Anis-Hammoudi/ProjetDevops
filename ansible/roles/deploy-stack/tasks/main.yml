---
# =============================================================================
# ROLE: deploy-stack - Deploiement de la stack GLPI
# =============================================================================

- name: Create stack directory
  file:
    path: /opt/glpi
    state: directory
    mode: '0755'

- name: Copy docker-compose file
  copy:
    src: "{{ playbook_dir }}/../files/docker-compose.yml"
    dest: /opt/glpi/docker-compose.yml
    mode: '0644'

- name: Copy nginx config
  copy:
    src: "{{ playbook_dir }}/../files/nginx.conf"
    dest: /opt/glpi/nginx.conf
    mode: '0644'

- name: Generate self-signed SSL certificate
  shell: |
    openssl req -x509 -nodes -days 365 \
      -newkey rsa:2048 \
      -keyout /opt/glpi/privkey.pem \
      -out /opt/glpi/fullchain.pem \
      -subj '/CN=glpi.local'
  args:
    creates: /opt/glpi/fullchain.pem

- name: Deploy GLPI stack
  shell: docker stack deploy -c /opt/glpi/docker-compose.yml glpi
  register: stack_deploy

- name: Wait for services to start
  pause:
    seconds: 15

- name: Show deployed services
  shell: docker service ls
  register: services
  changed_when: false

- name: Display services
  debug:
    var: services.stdout_lines
