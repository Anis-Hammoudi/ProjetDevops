---
# Deploy the GLPI stack on Docker Swarm

- name: Create stack directory
  file:
    path: "{{ docker_stack_path }}"
    state: directory
    mode: '0755'

- name: Create SSL directory
  file:
    path: "{{ ssl_cert_path }}"
    state: directory
    mode: '0755'

- name: Create nginx config directory
  file:
    path: "{{ docker_stack_path }}/nginx"
    state: directory
    mode: '0755'

- name: Generate self-signed SSL certificate for local testing
  command: >
    openssl req -x509 -nodes -days 365
    -newkey rsa:2048
    -keyout {{ ssl_cert_path }}/privkey.pem
    -out {{ ssl_cert_path }}/fullchain.pem
    -subj "/C=FR/ST=France/L=Paris/O=GLPI/CN={{ domain_name }}"
  args:
    creates: "{{ ssl_cert_path }}/fullchain.pem"

- name: Copy docker-compose stack file
  template:
    src: docker-compose.yml.j2
    dest: "{{ docker_stack_path }}/docker-compose.yml"
    mode: '0644'

- name: Copy nginx configuration
  template:
    src: nginx.conf.j2
    dest: "{{ docker_stack_path }}/nginx/nginx.conf"
    mode: '0644'

- name: Pull Docker images
  command: docker pull {{ item }}
  loop:
    - "diouxx/glpi:{{ glpi_version }}"
    - "mariadb:{{ mariadb_version }}"
    - "nginx:{{ nginx_version }}"
  changed_when: false

- name: Deploy stack to Swarm
  command: docker stack deploy -c {{ docker_stack_path }}/docker-compose.yml {{ swarm_stack_name }}
  register: stack_deploy

- name: Wait for services to be ready
  pause:
    seconds: 30

- name: Check stack services status
  command: docker service ls
  register: service_status
  changed_when: false

- name: Display stack status
  debug:
    var: service_status.stdout_lines
